<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Truss Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark shade if needed
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; 
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            flex-shrink: 0;
        }
        main {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }
        @media (max-width: 767px) {
            main {
                flex-direction: column;
            }
            #sidebar {
                height: 40vh;
                min-height: 200px;
                flex-shrink: 0;
            }
            #canvas-container {
                height: 60vh;
            }
        }
        @media (min-width: 768px) {
            #sidebar {
                width: 320px;
                flex-shrink: 0;
            }
            #canvas-container {
                flex-grow: 1;
            }
        }
        
        #truss-canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        .modal {
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            width: 90%;
            max-width: 400px;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Tooltip style */
        [data-tooltip] {
            position: relative;
            cursor: pointer;
        }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
            background-color: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }
        [data-tooltip]:hover::after {
            visibility: visible;
            opacity: 1;
        }

        /* Custom range slider appearance */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
        }
        html.dark input[type="range"] {
            background: #4b5563;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        html.dark input[type="range"]::-webkit-slider-thumb {
            background: #3b82f6;
        }

        /* Unit spans for JS */
        .unit-len { content: "mm"; }
        .unit-force { content: "N"; }
        .unit-pressure { content: "MPa"; }
        .unit-area { content: "mm²"; }
    </style>
    <script>
        // Apply theme from localStorage immediately to prevent flash
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="h-full bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 transition-colors duration-200">

    <header class="p-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex flex-wrap items-center justify-between gap-2 transition-colors duration-200">
        <div class="flex items-center gap-2 flex-wrap">
             <button id="file-new" data-tooltip="New (Ctrl+N)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-file"></i>
            </button>
            <button id="file-open" data-tooltip="Open Model (.truss)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-folder-open"></i>
            </button>
            <button id="file-save" data-tooltip="Save Model (.truss)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-save"></i>
            </button>
            <button id="save-image" data-tooltip="Save Image (.png)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-camera"></i>
            </button>
            <button id="save-report" data-tooltip="Save Summary Report (.pdf)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-file-pdf"></i>
            </button>
            <button id="save-calc-report" data-tooltip="Save Calculation Report (.txt)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-file-invoice"></i>
            </button>
        </div>

        <div class="flex items-center gap-1 flex-wrap p-1 bg-slate-200 dark:bg-slate-700 rounded-md transition-colors duration-200">
            <button id="tool-select" data-tooltip="Select (Q)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-mouse-pointer"></i>
            </button>
            <button id="tool-pan" data-tooltip="Pan (P)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-hand"></i>
            </button>
            <button id="tool-node" data-tooltip="Add Node (N)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-circle"></i>
            </button>
            <button id="tool-node-xy" data-tooltip="Add Node by XY (X)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-plus-square"></i>
            </button>
            <button id="tool-member" data-tooltip="Add Member (M)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-minus"></i>
            </button>
            <button id="tool-support-pin" data-tooltip="Add Pin Support (S)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </button>
            <button id="tool-support-roller" data-tooltip="Add Roller Support (R)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-circle-notch"></i>
            </button>
            <button id="tool-load" data-tooltip="Add Nodal Load (L)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-arrow-down"></i>
            </button>
            <button id="tool-divide-member" data-tooltip="Divide Member (V)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-code-branch"></i>
            </button>
            <button id="tool-delete" data-tooltip="Delete (Del)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
            <button id="zoom-fit" data-tooltip="Zoom to Fit (F)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-expand"></i>
            </button>
            <button id="zoom-out" data-tooltip="Zoom Out (-)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-search-minus"></i>
            </button>
            <button id="zoom-in" data-tooltip="Zoom In (=)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-search-plus"></i>
            </button>
            <button id="reset-view" data-tooltip="Reset View" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-compass"></i>
            </button>
            
            <div class="flex items-center gap-1 text-sm text-slate-600 dark:text-slate-300">
                <label for="grid-size" data-tooltip="Grid Spacing">Grid:</label>
                <input type="number" id="grid-size" value="50" min="0.1" class="w-14 h-9 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm dark:text-white">
            </div>

            <button id="toggle-grid" data-tooltip="Toggle Grid (G)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-border-all"></i>
            </button>
            
            <button id="toggle-snap" data-tooltip="Toggle Snap" class="w-9 h-9 flex items-center justify-center rounded-md bg-slate-300 dark:bg-slate-600 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-magnet"></i>
            </button>
            
            <button id="toggle-deformed" data-tooltip="Toggle Deformed Shape (D)" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-draw-polygon"></i>
            </button>
            
            <div id="disp-scale-container" class="items-center gap-1 text-sm text-slate-600 dark:text-slate-300 hidden">
                <label for="disp-scale" data-tooltip="Displacement Scale">Disp. Scale:</label>
                <input type="number" id="disp-scale" value="100" min="0" class="w-16 h-9 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm dark:text-white">
            </div>

            <button id="theme-toggle" data-tooltip="Toggle Theme" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-moon"></i>
                <i class="fa-solid fa-sun hidden"></i>
            </button>
            <button id="show-settings" data-tooltip="Settings" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button id="show-about" data-tooltip="About" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-info-circle"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <aside id="sidebar" class="w-full md:w-80 p-4 border-l md:border-l-0 border-r border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 overflow-y-auto transition-colors duration-200">
            
            <button id="analyze-button" class="w-full h-10 px-4 flex items-center justify-center rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 mb-4">
                <i class="fa-solid fa-calculator mr-2"></i>
                Analyze
            </button>

            <div id="results-container" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-slate-800 dark:text-slate-200 text-lg">Analysis Results</h3>
                    <button id="clear-results" title="Clear Results" class="text-slate-500 hover:text-red-600 dark:hover:text-red-400">
                        <i class="fa-solid fa-times-circle"></i>
                    </button>
                </div>
                <div id="analysis-status" class="p-2 rounded-md mb-3 text-sm"></div>
                <div id="results-tables">
                    <div class="mb-4">
                        <h4 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">Member Forces</h4>
                        <div class="max-h-48 overflow-y-auto border border-slate-200 dark:border-slate-600 rounded-md">
                            <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                <thead class="text-xs text-slate-700 dark:text-slate-200 uppercase bg-slate-100 dark:bg-slate-700 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-3 py-2">Member</th>
                                        <th scope="col" class="px-3 py-2 text-right">Force (<span class="unit-force">N</span>)</th>
                                        <th scope="col" class="px-3 py-2 text-right">Stress (<span class="unit-pressure">MPa</span>)</th>
                                    </tr>
                                </thead>
                                <tbody id="member-forces-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">Support Reactions</h4>
                         <div class="border border-slate-200 dark:border-slate-600 rounded-md overflow-hidden">
                            <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                <thead class="text-xs text-slate-700 dark:text-slate-200 uppercase bg-slate-100 dark:bg-slate-700">
                                    <tr>
                                        <th scope="col" class="px-3 py-2">Node</th>
                                        <th scope="col" class="px-3 py-2 text-right">Rx (<span class="unit-force">N</span>)</th>
                                        <th scope="col" class="px-3 py-2 text-right">Ry (<span class="unit-force">N</span>)</th>
                                    </tr>
                                </thead>
                                <tbody id="reactions-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">Nodal Displacements</h4>
                         <div class="max-h-40 overflow-y-auto border border-slate-200 dark:border-slate-600 rounded-md">
                            <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                <thead class="text-xs text-slate-700 dark:text-slate-200 uppercase bg-slate-100 dark:bg-slate-700 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-3 py-2">Node</th>
                                        <th scope="col" class="px-3 py-2 text-right">dx (<span class="unit-len">mm</span>)</th>
                                        <th scope="col" class="px-3 py-2 text-right">dy (<span class="unit-len">mm</span>)</th>
                                    </tr>
                                </thead>
                                <tbody id="displacements-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="properties-panel">
                <h3 id="prop-title" class="font-semibold text-slate-800 dark:text-slate-200 text-lg mb-3">Properties</h3>
                <div id="prop-none" class="text-sm text-slate-500 dark:text-slate-400">
                    Click on an item (node, member, etc.) to see its properties.
                </div>

                <div id="prop-node" class="space-y-3 hidden">
                    <div>
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Node ID: </span>
                        <span id="prop-node-id" class="font-semibold"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label for="prop-node-x" class="block text-sm font-medium text-slate-700 dark:text-slate-300">X Coordinate (<span class="unit-len">mm</span>)</label>
                            <input type="number" id="prop-node-x" step="0.1" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                        </div>
                         <div>
                            <label for="prop-node-y" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Y Coordinate (<span class="unit-len">mm</span>)</label>
                            <input type="number" id="prop-node-y" step="0.1" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                        </div>
                    </div>
                    <button id="prop-node-delete" class="w-full h-9 px-4 flex items-center justify-center rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-2"></i>Delete Node
                    </button>
                </div>

                <div id="prop-member" class="space-y-3 hidden">
                     <div>
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Member ID: </span>
                        <span id="prop-member-id" class="font-semibold"></span>
                    </div>
                    <div>
                        <label for="prop-member-e" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Elastic Modulus (E) <span class="text-xs text-slate-500">(<span class="unit-pressure">MPa</span>)</span></label>
                        <input type="number" id="prop-member-e" value="200000" min="1" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                    </div>
                    <div>
                        <label for="prop-member-a" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Area (A) <span class="text-xs text-slate-500">(<span class="unit-area">mm²</span>)</span></label>
                        <input type="number" id="prop-member-a" value="1000" min="1" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                    </div>
                     <button id="prop-member-split" class="w-full h-9 px-4 flex items-center justify-center rounded-md bg-slate-600 text-white font-semibold hover:bg-slate-700 dark:bg-slate-500 dark:hover:bg-slate-600">
                        <i class="fa-solid fa-code-branch mr-2"></i>Divide Member
                    </button>
                    <button id="prop-member-delete" class="w-full h-9 px-4 flex items-center justify-center rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-2"></i>Delete Member
                    </button>
                </div>
                
                <div id="prop-support" class="space-y-3 hidden">
                    <div>
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Support at Node: </span>
                        <span id="prop-support-node" class="font-semibold"></span>
                    </div>
                    <div>
                        <label for="prop-support-type" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Support Type</label>
                        <select id="prop-support-type" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white mt-1">
                            <option value="pinned">Pinned</option>
                            <option value="roller-y">Roller (Vertical)</option>
                            <option value="roller-x">Roller (Horizontal)</option>
                        </select>
                    </div>
                     <button id="prop-support-delete" class="w-full h-9 px-4 flex items-center justify-center rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-2"></i>Delete Support
                    </button>
                </div>
                
                <div id="prop-load" class="space-y-3 hidden">
                     <div>
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Load at Node: </span>
                        <span id="prop-load-node" class="font-semibold"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label for="prop-load-fx" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Force X (<span class="unit-force">N</span>)</label>
                            <input type="number" id="prop-load-fx" step="100" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                        </div>
                         <div>
                            <label for="prop-load-fy" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Force Y (<span class="unit-force">N</span>)</label>
                            <input type="number" id="prop-load-fy" step="100" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                        </div>
                    </div>
                    <button id="prop-load-delete" class="w-full h-9 px-4 flex items-center justify-center rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-2"></i>Delete Load
                    </button>
                </div>

            </div>

        </aside>

        <div id="canvas-container" class="flex-1 bg-white dark:bg-slate-900 overflow-hidden relative transition-colors duration-200">
            <canvas id="truss-canvas"></canvas>
            <div id="coords-display" class="absolute bottom-2 left-12 text-sm text-slate-500 dark:text-slate-400 bg-white/70 dark:bg-slate-900/70 px-2 py-0.5 rounded pointer-events-none">
                X: 0.0, Y: 0.0
            </div>
        </div>
    </main>

    <div id="modal-node-coords" class="modal" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">Add Node by Coordinates</h3>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="coord-x" class="block text-sm font-medium text-slate-700 dark:text-slate-300">X Coordinate (<span class="unit-len">mm</span>)</label>
                    <input type="number" id="coord-x" step="0.1" value="0" class="mt-1 w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                </div>
                <div>
                    <label for="coord-y" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Y Coordinate (<span class="unit-len">mm</span>)</label>
                    <input type="number" id="coord-y" step="0.1" value="0" class="mt-1 w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button id="modal-coord-cancel" class="h-9 px-4 flex items-center justify-center rounded-md bg-slate-200 text-slate-800 font-semibold hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-100 dark:hover:bg-slate-500">Cancel</button>
                <button id="modal-coord-ok" class="h-9 px-4 flex items-center justify-center rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-divide-member" class="modal" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">Divide Member</h3>
            <div>
                <label for="divide-segments" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Divide member into how many segments?</label>
                <input type="number" id="divide-segments" min="2" step="1" value="2" class="mt-1 w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button id="modal-divide-cancel" class="h-9 px-4 flex items-center justify-center rounded-md bg-slate-200 text-slate-800 font-semibold hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-100 dark:hover:bg-slate-500">Cancel</button>
                <button id="modal-divide-ok" class="h-9 px-4 flex items-center justify-center rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600">OK</button>
            </div>
        </div>
    </div>

     <div id="modal-settings" class="modal" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700">
             <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">Settings</h3>
             
             <div class="mb-4">
                 <h4 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">Unit System</h4>
                 <div class="space-y-2">
                    <label for="unit-system-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Units</label>
                    <select id="unit-system-select" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm h-9 dark:text-white">
                        <option value="metric">Metric (N, mm, MPa)</option>
                        <option value="imperial">Imperial (kips, in, ksi)</option>
                    </select>
                 </div>
             </div>

            <div id="default-props-container-modal" class="mb-6">
                <h3 class="font-semibold text-slate-800 dark:text-slate-200 text-lg mb-3">Default Member Properties</h3>
                <div class="space-y-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                    <div>
                        <label for="default-E" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Elastic Modulus (E) <span class="text-xs text-slate-500">(<span class="unit-pressure">MPa</span>)</span></label>
                        <input type="number" id="default-E" value="200000" min="1" class="w-full bg-white dark:bg-slate-600 border border-slate-300 dark:border-slate-500 rounded-md p-1.5 text-sm h-9 dark:text-white">
                    </div>
                    <div>
                        <label for="default-A" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Area (A) <span class="text-xs text-slate-500">(<span class="unit-area">mm²</span>)</span></label>
                        <input type="number" id="default-A" value="1000" min="1" class="w-full bg-white dark:bg-slate-600 border border-slate-300 dark:border-slate-500 rounded-md p-1.5 text-sm h-9 dark:text-white">
                    </div>
                </div>
            </div>

             <div>
                 <h4 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">View Settings</h4>
                 <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="toggle-node-labels" class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded dark:ring-offset-slate-800 dark:bg-slate-700 dark:border-slate-600">
                        <label for="toggle-node-labels" class="text-sm text-slate-700 dark:text-slate-300">Show Node Labels</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="toggle-member-labels" class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded dark:ring-offset-slate-800 dark:bg-slate-700 dark:border-slate-600">
                        <label for="toggle-member-labels" class="text-sm text-slate-700 dark:text-slate-300">Show Member Labels</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="toggle-load-values" class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded dark:ring-offset-slate-800 dark:bg-slate-700 dark:border-slate-600">
                        <label for="toggle-load-values" class="text-sm text-slate-700 dark:text-slate-300">Show Load Values</label>
                    </div>
                    
                     <div>
                        <label for="prop-scale" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Support & Load Scale (<span id="prop-scale-value">1.0</span>x)</label>
                        <input type="range" id="prop-scale" min="0.1" max="5" value="1" step="0.1" class="w-full h-2 bg-slate-200 dark:bg-slate-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                 </div>
             </div>

             <div class="flex justify-end mt-5">
                 <button id="modal-settings-close" class="h-9 px-4 flex items-center justify-center rounded-md bg-slate-200 text-slate-800 font-semibold hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-100 dark:hover:bg-slate-500">Close</button>
             </div>
        </div>
    </div>

    <div id="modal-about" class="modal" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">About</h3>
            <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
                This tool provides a simple interface for 2D truss analysis using the Direct Stiffness Method.
            </p>
			<div class="text-sm text-slate-600 dark:text-slate-400 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                <h4 class="font-semibold text-slate-700 dark:text-slate-300 mb-1">Developed by:</h4>
                <p class="font-medium text-slate-800 dark:text-slate-200">Dr. Tahmina Tasnin Nahar & Dr. Md. Motiur Rahman</p>
                <p>Department of Civil Engineering</p>
                <p>Pabna University of Science and Technology</p>
            </div>
             <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
                <strong>Shortcuts:</strong><br>
                Move/Select: Q<br>
                Pan: P<br>
                Add Node: N<br>
                Add Member: M<br>
                Pin Support: S<br>
                Roller Support: R<br>
                Add Load: L<br>
                Delete: Del<br>
                Zoom: + / -<br>
                Fit: F
            </p>
            <div class="flex justify-end">
                <button id="modal-about-close" class="h-9 px-4 flex items-center justify-center rounded-md bg-slate-200 text-slate-800 font-semibold hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-100 dark:hover:bg-slate-500">Close</button>
            </div>
        </div>
    </div>
    
    <div id="modal-progress" class="modal" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700 flex flex-col items-center justify-center">
             <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-3"></i>
             <span id="progress-text" class="text-slate-800 dark:text-slate-200 font-medium">Processing...</span>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        const canvas = document.getElementById('truss-canvas');
        const ctx = canvas.getContext('2d');
        
        // Data structures (STORED IN METRIC/BASE UNITS)
        let nodes = [];
        let members = [];
        let supports = [];
        let loads = [];
        
        let nextNodeId = 1;
        let nextMemberId = 1;
        let nextSupportId = 1;
        let nextLoadId = 1;
        
        // View state
        let transform = { x: 0, y: 0, k: 1 }; // Pan x, y and Zoom k
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let lastMouse = { x: 0, y: 0 };
        let worldMouse = { x: 0, y: 0 };
        
        // Tool state
        let activeTool = 'select';
        let memberStartNode = null;
        
        // Selection
        let selection = null; 
        let hoverItem = null;
        
        // Analysis Results
        let analysisRun = false;
        let displacements = [];
        let reactions = [];
        let isDeformedView = false;
        
        // Settings & Preferences
        let showGrid = true;
        let enableSnap = true;
        let showNodeLabels = false;
        let showMemberLabels = false;
        let showLoadValues = true;
        let propScale = 1.0;
        
        // Unit System Constants
        const MM_PER_IN = 25.4;
        const MPA_PER_KSI = 6.89476;
        const N_PER_LBF = 4.44822;
        const N_PER_KIP = 4448.22;
        
        let currentUnitSystem = 'metric'; // 'metric' or 'imperial'
        
        const unitSystems = {
            metric: {
                len: 'mm',
                force: 'N',
                pressure: 'MPa',
                area: 'mm²',
                E: 200000, // MPa (Steel)
                A: 1000    // mm²
            },
            imperial: {
                len: 'in',
                force: 'kips',
                pressure: 'ksi',
                area: 'in²',
                E: 29000,  // ksi (Steel)
                A: 2       // in²
            }
        };

        // Constants
        const SNAP_DIST_SCREEN = 10;
        const COORD_PRECISION = 2; 

        // --- DOM ELEMENTS ---
        const sidebar = document.getElementById('sidebar');
        const analyzeButton = document.getElementById('analyze-button');
        const resultsContainer = document.getElementById('results-container');
        const analysisStatus = document.getElementById('analysis-status');
        const memberForcesTbody = document.getElementById('member-forces-tbody');
        const reactionsTbody = document.getElementById('reactions-tbody');
        const displacementsTbody = document.getElementById('displacements-tbody');
        
        const propertiesPanel = document.getElementById('properties-panel');
        const propTitle = document.getElementById('prop-title');
        const propNone = document.getElementById('prop-none');
        
        const propNode = document.getElementById('prop-node');
        const propMember = document.getElementById('prop-member');
        const propSupport = document.getElementById('prop-support');
        const propLoad = document.getElementById('prop-load');

        const gridSizeInput = document.getElementById('grid-size');
        const dispScaleInput = document.getElementById('disp-scale');
        const dispScaleContainer = document.getElementById('disp-scale-container');
        const deformedToggleBtn = document.getElementById('toggle-deformed');
        
        const unitSystemSelect = document.getElementById('unit-system-select');
        const allUnitLen = document.querySelectorAll('.unit-len');
        const allUnitForce = document.querySelectorAll('.unit-force');
        const allUnitPressure = document.querySelectorAll('.unit-pressure');
        const allUnitArea = document.querySelectorAll('.unit-area');
        
        const themeToggleBtn = document.getElementById('theme-toggle');
        
        // --- UNIT CONVERSION HELPERS ---
        
        function getFactorToBase(type) {
            if (currentUnitSystem === 'metric') return 1.0;
            
            // Imperial to Metric (Base)
            if (type === 'len') return MM_PER_IN;
            if (type === 'force') return N_PER_KIP;
            if (type === 'pressure') return MPA_PER_KSI;
            if (type === 'area') return MM_PER_IN * MM_PER_IN;
            return 1.0;
        }

        function getFactorFromBase(type) {
             if (currentUnitSystem === 'metric') return 1.0;
             
             // Metric (Base) to Imperial
            if (type === 'len') return 1.0 / MM_PER_IN;
            if (type === 'force') return 1.0 / N_PER_KIP;
            if (type === 'pressure') return 1.0 / MPA_PER_KSI;
            if (type === 'area') return 1.0 / (MM_PER_IN * MM_PER_IN);
            
            return 1.0;
        }
        
        function toBaseUnit(value, type) {
            return value * getFactorToBase(type);
        }

        function fromBaseUnit(value, type) {
            return value * getFactorFromBase(type);
        }

        function updateUnitSystemUI() {
            const system = unitSystems[currentUnitSystem];
            
            // Update all labels
            allUnitLen.forEach(el => el.textContent = system.len);
            allUnitForce.forEach(el => el.textContent = system.force);
            allUnitPressure.forEach(el => el.textContent = system.pressure);
            allUnitArea.forEach(el => el.textContent = system.area);
            
            // Update Inputs to Standard Defaults for that system
            document.getElementById('default-E').value = system.E;
            document.getElementById('default-A').value = system.A;
            
            // Update Grid Input
            if (currentUnitSystem === 'metric') gridSizeInput.value = "50";
            else gridSizeInput.value = "2"; 
        }
        
        // --- INITIALIZATION ---
        
        function init() {
            resizeCanvas();
            
            // Event Listeners
            window.addEventListener('resize', resizeCanvas);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('wheel', handleWheel, { passive: false });
            canvas.addEventListener('contextmenu', e => e.preventDefault());

            // Tools
            document.getElementById('tool-select').addEventListener('click', () => setActiveTool('select'));
            document.getElementById('tool-pan').addEventListener('click', () => setActiveTool('pan'));
            document.getElementById('tool-node').addEventListener('click', () => setActiveTool('node'));
            document.getElementById('tool-node-xy').addEventListener('click', openNodeModal);
            document.getElementById('tool-member').addEventListener('click', () => setActiveTool('member'));
            document.getElementById('tool-support-pin').addEventListener('click', () => setActiveTool('support-pin'));
            document.getElementById('tool-support-roller').addEventListener('click', () => setActiveTool('support-roller'));
            document.getElementById('tool-load').addEventListener('click', () => setActiveTool('load'));
            document.getElementById('tool-divide-member').addEventListener('click', () => setActiveTool('divide-member'));
            document.getElementById('tool-delete').addEventListener('click', () => setActiveTool('delete'));
            
            // View Controls
            document.getElementById('zoom-in').addEventListener('click', () => zoom(1.2, canvas.width/2, canvas.height/2));
            document.getElementById('zoom-out').addEventListener('click', () => zoom(1/1.2, canvas.width/2, canvas.height/2));
            document.getElementById('zoom-fit').addEventListener('click', zoomToFit);
            document.getElementById('reset-view').addEventListener('click', () => { transform = {x:0, y:0, k:1}; draw(); });
            
            document.getElementById('toggle-grid').addEventListener('click', (e) => {
                showGrid = !showGrid;
                e.currentTarget.classList.toggle('bg-slate-300', showGrid); 
                e.currentTarget.classList.toggle('dark:bg-slate-600', showGrid);
                draw();
            });
            
            // Toggle Snap
            document.getElementById('toggle-snap').addEventListener('click', (e) => {
                enableSnap = !enableSnap;
                e.currentTarget.classList.toggle('bg-slate-300', enableSnap); 
                e.currentTarget.classList.toggle('dark:bg-slate-600', enableSnap);
            });
            
            deformedToggleBtn.addEventListener('click', () => toggleDeformedView(!isDeformedView));

            // File Operations
            document.getElementById('file-new').addEventListener('click', () => {
                if(confirm("Clear current model? Unsaved changes will be lost.")) {
                    nodes=[]; members=[]; supports=[]; loads=[];
                    nextNodeId=1; nextMemberId=1; nextSupportId=1; nextLoadId=1;
                    clearAnalysisResults();
                    selectObject(null);
                    draw();
                }
            });
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.truss';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            fileInput.addEventListener('change', handleFileOpen);
            
            document.getElementById('file-open').addEventListener('click', () => fileInput.click());
            document.getElementById('file-save').addEventListener('click', saveFile);
            
            // Reporting
            document.getElementById('save-image').addEventListener('click', () => saveImage('png'));
            document.getElementById('save-report').addEventListener('click', handleSaveReport);
            
            // Save Calculation Report (Text File)
            document.getElementById('save-calc-report').addEventListener('click', () => {
                const log = document.getElementById('save-calc-report').dataset.log;
                if (!log) {
                    alert("Run analysis first to generate the report.");
                    return;
                }
                const blob = new Blob([log], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'truss_calculation_report.txt';
                a.click();
                URL.revokeObjectURL(a.href);
            });
            
            // Theme Toggle
            themeToggleBtn.addEventListener('click', handleThemeToggle);
            updateThemeIcons();
            
            // Settings & About
            const modalSettings = document.getElementById('modal-settings');
            const modalAbout = document.getElementById('modal-about');
            document.getElementById('show-settings').addEventListener('click', () => modalSettings.style.display = 'flex');
            document.getElementById('show-about').addEventListener('click', () => modalAbout.style.display = 'flex');
            document.getElementById('modal-settings-close').addEventListener('click', () => modalSettings.style.display = 'none');
            document.getElementById('modal-about-close').addEventListener('click', () => modalAbout.style.display = 'none');
            
            // Modals
            const modalNodeCoords = document.getElementById('modal-node-coords');
            document.getElementById('modal-coord-cancel').addEventListener('click', () => modalNodeCoords.style.display = 'none');
            document.getElementById('modal-coord-ok').addEventListener('click', addNodeFromModal);
            
            const modalDivide = document.getElementById('modal-divide-member');
            document.getElementById('modal-divide-cancel').addEventListener('click', () => {
                modalDivide.style.display = 'none';
                selectObject(null);
            });
            document.getElementById('modal-divide-ok').addEventListener('click', performDivideMember);

            // Settings Inputs & Unit Conversion
            unitSystemSelect.addEventListener('change', (e) => {
                const newSystem = e.target.value;
                currentUnitSystem = newSystem;
                localStorage.setItem('trussUnitSystem', currentUnitSystem);
                
                updateUnitSystemUI();
                
                if (analysisRun) displayResults(); // Update table
                
                draw();
                selectObject(selection); 
            });
            
            const toggleNodeLabels = document.getElementById('toggle-node-labels');
            const toggleMemberLabels = document.getElementById('toggle-member-labels');
            const toggleLoadValues = document.getElementById('toggle-load-values');
            const propScaleSlider = document.getElementById('prop-scale');
            const propScaleValue = document.getElementById('prop-scale-value');

            toggleNodeLabels.addEventListener('change', (e) => { showNodeLabels = e.target.checked; draw(); });
            toggleMemberLabels.addEventListener('change', (e) => { showMemberLabels = e.target.checked; draw(); });
            toggleLoadValues.addEventListener('change', (e) => { showLoadValues = e.target.checked; draw(); });
            
            toggleLoadValues.checked = showLoadValues;

            propScaleSlider.addEventListener('input', (e) => {
                propScale = parseFloat(e.target.value);
                propScaleValue.textContent = propScale.toFixed(1);
                draw();
            });
            
            // Analysis
            analyzeButton.addEventListener('click', handleAnalyze);
            document.getElementById('clear-results').addEventListener('click', clearAnalysisResults);

            // Input listeners (Properties)
            document.getElementById('prop-node-x').addEventListener('change', (e) => updateNodeProp('x', e.target.value));
            document.getElementById('prop-node-y').addEventListener('change', (e) => updateNodeProp('y', e.target.value));
            document.getElementById('prop-node-delete').addEventListener('click', deleteSelected);
            
            document.getElementById('prop-member-e').addEventListener('change', (e) => updateMemberProp('E', e.target.value));
            document.getElementById('prop-member-a').addEventListener('change', (e) => updateMemberProp('A', e.target.value));
            document.getElementById('prop-member-split').addEventListener('click', openDivideModal);
            document.getElementById('prop-member-delete').addEventListener('click', deleteSelected);
            
            document.getElementById('prop-support-type').addEventListener('change', (e) => updateSupportProp(e.target.value));
            document.getElementById('prop-support-delete').addEventListener('click', deleteSelected);
            
            document.getElementById('prop-load-fx').addEventListener('change', (e) => updateLoadProp('fx', e.target.value));
            document.getElementById('prop-load-fy').addEventListener('change', (e) => updateLoadProp('fy', e.target.value));
            document.getElementById('prop-load-delete').addEventListener('click', deleteSelected);

            gridSizeInput.addEventListener('input', handleGridSizeChange);
            dispScaleInput.addEventListener('input', handleDispScaleChange);

            window.addEventListener('keydown', handleKeyDown);
            
            // Load State
            const savedUnitSystem = localStorage.getItem('trussUnitSystem') || 'metric';
            currentUnitSystem = savedUnitSystem;
            unitSystemSelect.value = savedUnitSystem;
            updateUnitSystemUI();
            
            resizeCanvas();
            setActiveTool('select');
            requestAnimationFrame(draw);
        }

        function handleGridSizeChange() {
            draw();
        }

        function handleThemeToggle() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons();
            draw();
        }

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const moonIcon = themeToggleBtn.querySelector('.fa-moon');
            const sunIcon = themeToggleBtn.querySelector('.fa-sun');
            if (isDark) {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        }

        // --- DRAWING ---
        
        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
        
        function draw() {
            const isDark = document.documentElement.classList.contains('dark');
            const bgColor = isDark ? '#0f172a' : '#ffffff'; 
            const gridColor = isDark ? '#1e293b' : '#e2e8f0'; 
            const axisColor = isDark ? '#475569' : '#94a3b8'; 
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);
            
            if (showGrid) {
                drawGrid(gridColor, axisColor);
            }
            
            if (isDeformedView && analysisRun) {
                ctx.globalAlpha = 0.2;
                drawMembers(nodes); 
                ctx.globalAlpha = 1.0;
                
                const deformedNodes = getDeformedNodes();
                drawMembers(deformedNodes, true);
                drawSupports(deformedNodes);
                drawLoads(deformedNodes);
                drawNodes(deformedNodes);
            } else {
                drawMembers(nodes);
                drawSupports(nodes);
                drawLoads(nodes);
                drawNodes(nodes);
            }
            
            drawToolHints();
            ctx.restore();
            
            drawAxisHUD();
            updateCoordsDisplay();
        }
        
        function drawGrid(color, axisColor) {
            // Convert grid input (Display Units) to Base Units (mm)
            const gridInputVal = parseFloat(gridSizeInput.value) || 50;
            const gridSize = toBaseUnit(gridInputVal, 'len');
            
            const gridSizeScreen = gridSize * transform.k;
            if (gridSizeScreen < 5) return; 
            
            const left = -transform.x / transform.k;
            const top = -transform.y / transform.k;
            const right = (canvas.width - transform.x) / transform.k;
            const bottom = (canvas.height - transform.y) / transform.k;
            
            const startX = Math.floor(left / gridSize) * gridSize;
            const startY = Math.floor(top / gridSize) * gridSize;
            
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1 / transform.k; 
            
            for (let x = startX; x <= right; x += gridSize) {
                ctx.moveTo(x, top);
                ctx.lineTo(x, bottom);
            }
            for (let y = startY; y <= bottom; y += gridSize) {
                ctx.moveTo(left, y);
                ctx.lineTo(right, y);
            }
            ctx.stroke();
        }
        
        function drawAxisHUD() {
            const isDark = document.documentElement.classList.contains('dark');
            const size = 40;
            const padding = 10;
            const originX = padding + 20; 
            const originY = canvas.height - padding - 20;
            
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform to screen space
            
            ctx.lineWidth = 2;
            ctx.font = "12px sans-serif";
            ctx.fillStyle = isDark ? "#fff" : "#000";
            
            // X Axis (Red)
            ctx.beginPath();
            ctx.strokeStyle = "#ef4444";
            ctx.moveTo(originX, originY);
            ctx.lineTo(originX + size, originY);
            ctx.stroke();
            ctx.fillText("X", originX + size + 5, originY + 4);
            
            // Y Axis (Green) - Upward visual, but canvas Y is down.
            // Standard CAD shows Y up. We'll draw Y up relative to screen corner.
            ctx.beginPath();
            ctx.strokeStyle = "#22c55e";
            ctx.moveTo(originX, originY);
            ctx.lineTo(originX, originY - size);
            ctx.stroke();
            ctx.fillText("Y", originX - 4, originY - size - 5);
            
            // Origin Dot
            ctx.beginPath();
            ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
            ctx.arc(originX, originY, 3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }
        
        function drawNodes(nodeList) {
            const isDark = document.documentElement.classList.contains('dark');
            const nodeColor = isDark ? '#94a3b8' : '#64748b'; 
            const selectedColor = '#2563eb'; 
            const radius = 4 / transform.k;
            
            ctx.font = `${12/transform.k}px sans-serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            const textFill = isDark ? '#e2e8f0' : '#1e293b';

            nodeList.forEach(node => {
                ctx.beginPath();
                ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI);
                
                if (selection && selection.type === 'node' && selection.id === node.id) {
                    ctx.fillStyle = selectedColor;
                } else if (hoverItem && hoverItem.type === 'node' && hoverItem.id === node.id) {
                    ctx.fillStyle = '#3b82f6'; 
                } else {
                    ctx.fillStyle = nodeColor;
                }
                
                ctx.fill();
                
                if (showNodeLabels) {
                    ctx.fillStyle = textFill;
                    ctx.fillText(node.id, node.x, node.y - radius * 3);
                }
            });
        }
        
        function drawMembers(nodeList, useStressColor = false) {
            const isDark = document.documentElement.classList.contains('dark');
            const defaultColor = isDark ? '#e2e8f0' : '#334155';
            const selectedColor = '#2563eb';
            const width = 2 / transform.k;
            
            ctx.lineWidth = width;
            ctx.font = `${12/transform.k}px sans-serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            const textFill = isDark ? '#e2e8f0' : '#1e293b';

            members.forEach(member => {
                const n1 = nodeList.find(n => n.id === member.n1);
                const n2 = nodeList.find(n => n.id === member.n2);
                if (!n1 || !n2) return;
                
                ctx.beginPath();
                ctx.moveTo(n1.x, n1.y);
                ctx.lineTo(n2.x, n2.y);
                
                if (selection && selection.type === 'member' && selection.id === member.id) {
                    ctx.strokeStyle = selectedColor;
                    ctx.lineWidth = width * 2;
                } else if (hoverItem && hoverItem.type === 'member' && hoverItem.id === member.id) {
                     ctx.strokeStyle = '#3b82f6';
                     ctx.lineWidth = width * 1.5;
                } else if (useStressColor) {
                    const s = member.stress || 0;
                    if (Math.abs(s) < 1e-6) {
                         ctx.strokeStyle = isDark ? '#94a3b8' : '#cbd5e1';
                    } else if (s > 0) {
                        ctx.strokeStyle = '#2563eb'; // Tension
                    } else {
                        ctx.strokeStyle = '#dc2626'; // Compression
                    }
                    ctx.lineWidth = width;
                } else {
                    ctx.strokeStyle = defaultColor;
                    ctx.lineWidth = width;
                }
                
                ctx.stroke();
                
                if (showMemberLabels) {
                    const mx = (n1.x + n2.x) / 2;
                    const my = (n1.y + n2.y) / 2;
                    ctx.fillStyle = textFill;
                    ctx.fillText(`M${member.id}`, mx, my - width * 2);
                }
            });
        }

        function drawSupports(nodeList) {
            const color = '#10b981'; 
            const selectedColor = '#2563eb';
            
            const baseSize = 15; 
            const s = (baseSize / transform.k) * propScale; 
            
            ctx.lineWidth = 2 / transform.k;
            
            supports.forEach(support => {
                const node = nodeList.find(n => n.id === support.nodeId);
                if (!node) return;
                
                const p = { x: node.x, y: node.y };
                
                ctx.beginPath();
                if (selection && selection.type === 'support' && selection.id === support.id) {
                    ctx.strokeStyle = selectedColor;
                    ctx.fillStyle = selectedColor;
                } else if (hoverItem && hoverItem.type === 'support' && hoverItem.id === support.id) {
                    ctx.strokeStyle = '#34d399';
                    ctx.fillStyle = '#34d399';
                } else {
                    ctx.strokeStyle = color;
                    ctx.fillStyle = color;
                }
                
                if (support.type === 'pinned') {
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x - s/2, p.y + s);
                    ctx.lineTo(p.x + s/2, p.y + s);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(p.x - s, p.y + s);
                    ctx.lineTo(p.x + s, p.y + s);
                    ctx.stroke();
                } else if (support.type === 'roller-y') {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y + s/2, s/2, 0, 2*Math.PI);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(p.x - s, p.y + s);
                    ctx.lineTo(p.x + s, p.y + s);
                    ctx.stroke();
                } else if (support.type === 'roller-x') {
                    ctx.beginPath();
                    ctx.arc(p.x - s/2, p.y, s/2, 0, 2*Math.PI);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(p.x - s, p.y - s);
                    ctx.lineTo(p.x - s, p.y + s);
                    ctx.stroke();
                }
            });
        }

        function drawLoads(nodeList) {
            const color = '#ef4444'; 
            const selectedColor = '#2563eb';
            
            const arrowLen = (30 / transform.k) * propScale;
            const headLen = (8 / transform.k) * propScale;
            
            ctx.lineWidth = 2 / transform.k;
            
            loads.forEach(load => {
                const node = nodeList.find(n => n.id === load.nodeId);
                if (!node) return;
                
                const magnitude = Math.sqrt(load.fx**2 + load.fy**2);
                if (magnitude === 0) return;
                
                const dx = load.fx / magnitude;
                const dy = load.fy / magnitude;
                
                const ex = node.x;
                const ey = node.y;
                const sx = ex - dx * arrowLen;
                const sy = ey - dy * arrowLen;
                
                ctx.beginPath();
                if (selection && selection.type === 'load' && selection.id === load.id) {
                    ctx.strokeStyle = selectedColor;
                    ctx.fillStyle = selectedColor;
                } else if (hoverItem && hoverItem.type === 'load' && hoverItem.id === load.id) {
                    ctx.strokeStyle = '#f87171';
                    ctx.fillStyle = '#f87171';
                } else {
                    ctx.strokeStyle = color;
                    ctx.fillStyle = color;
                }
                
                ctx.moveTo(sx, sy);
                ctx.lineTo(ex, ey);
                ctx.stroke();
                
                ctx.beginPath();
                const angle = Math.atan2(dy, dx);
                ctx.moveTo(ex, ey);
                ctx.lineTo(ex - headLen * Math.cos(angle - Math.PI / 6), ey - headLen * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(ex - headLen * Math.cos(angle + Math.PI / 6), ey - headLen * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
                
                if (showLoadValues) {
                    ctx.save();
                    ctx.fillStyle = ctx.strokeStyle; 
                    ctx.font = `${12/transform.k}px sans-serif`;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "bottom";
                    
                    const val = fromBaseUnit(magnitude, 'force').toFixed(1);
                    const unit = unitSystems[currentUnitSystem].force;
                    
                    ctx.fillText(`${val} ${unit}`, sx, sy - 5/transform.k);
                    ctx.restore();
                }
            });
        }

        function drawToolHints() {
            if (activeTool === 'member' && memberStartNode) {
                const sn = nodes.find(n => n.id === memberStartNode);
                if (sn) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#94a3b8'; 
                    ctx.setLineDash([5/transform.k, 5/transform.k]);
                    ctx.lineWidth = 1 / transform.k;
                    ctx.moveTo(sn.x, sn.y);
                    ctx.lineTo(worldMouse.x, worldMouse.y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
        }
        
        // --- INTERACTION HANDLERS ---
        
        function handleMouseDown(e) {
            if (e.button !== 0) return; 
            let pt = getMousePos(e);
            
            if (activeTool === 'pan') {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
                return;
            }
            
            if (activeTool === 'select') {
                const clickedNode = getClickedNode(pt);
                if (clickedNode) {
                    selectObject({ type: 'node', id: clickedNode.id });
                    isDragging = true; 
                    dragStart = { x: clickedNode.x, y: clickedNode.y }; 
                    return;
                }
                const clickedSupport = getClickedSupport(pt);
                if (clickedSupport) {
                    selectObject({ type: 'support', id: clickedSupport.id });
                    return;
                }
                const clickedLoad = getClickedLoad(pt);
                if (clickedLoad) {
                    selectObject({ type: 'load', id: clickedLoad.id });
                    return;
                }
                const clickedMember = getClickedMember(pt);
                if (clickedMember) {
                    selectObject({ type: 'member', id: clickedMember.id });
                    return;
                }
                selectObject(null);
            }
            
            // Creation Tools
            if (activeTool === 'node') {
                pt = snapPoint(pt);
                addNode(pt.x, pt.y);
            } else if (activeTool === 'member') {
                const clickedNode = getClickedNode(pt);
                if (clickedNode) {
                    if (memberStartNode === null) {
                        memberStartNode = clickedNode.id;
                    } else {
                        if (memberStartNode !== clickedNode.id) {
                            addMember(memberStartNode, clickedNode.id);
                            memberStartNode = null; 
                        }
                    }
                } else {
                    memberStartNode = null; 
                }
                draw();
            } else if (activeTool === 'support-pin' || activeTool === 'support-roller') {
                 const clickedNode = getClickedNode(pt);
                 if (clickedNode) {
                     addSupport(clickedNode.id, activeTool === 'support-pin' ? 'pinned' : 'roller-y');
                     setActiveTool('select'); 
                 }
            } else if (activeTool === 'load') {
                 const clickedNode = getClickedNode(pt);
                 if (clickedNode) {
                     addLoad(clickedNode.id);
                     setActiveTool('select');
                 }
            } else if (activeTool === 'divide-member') {
                const clickedMember = getClickedMember(pt);
                if (clickedMember) {
                    selectObject({ type: 'member', id: clickedMember.id });
                    openDivideModal();
                }
            } else if (activeTool === 'delete') {
                 const n = getClickedNode(pt);
                 if (n) { deleteNode(n.id); return; }
                 const s = getClickedSupport(pt);
                 if (s) { deleteSupport(s.id); return; }
                 const l = getClickedLoad(pt);
                 if (l) { deleteLoad(l.id); return; }
                 const m = getClickedMember(pt);
                 if (m) { deleteMember(m.id); return; }
            }
        }
        
        function handleMouseMove(e) {
            let pt = getMousePos(e);
            
            if (activeTool === 'pan' && isDragging) {
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                transform.x += dx;
                transform.y += dy;
                dragStart = { x: e.clientX, y: e.clientY };
                draw();
                return;
            }
            
            // Moving Node
            if (activeTool === 'select' && isDragging && selection && selection.type === 'node') {
                const node = nodes.find(n => n.id === selection.id);
                if (node) {
                    const targetPt = snapPoint(pt);
                    node.x = targetPt.x;
                    node.y = targetPt.y;
                    
                    if (analysisRun) clearAnalysisResults();
                    document.getElementById('prop-node-x').value = fromBaseUnit(node.x, 'len').toFixed(COORD_PRECISION);
                    document.getElementById('prop-node-y').value = fromBaseUnit(node.y, 'len').toFixed(COORD_PRECISION);
                    draw();
                }
            }
            
            updateHover(pt);
            
            if (enableSnap) {
                 worldMouse = snapPoint(pt);
            } else {
                 worldMouse = pt;
            }
            
            if (activeTool === 'member' && memberStartNode) draw();
            updateCoordsDisplay(pt);
        }
        
        function handleMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                canvas.style.cursor = 'default';
            }
        }
        
        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 1/1.1 : 1.1;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            zoom(delta, mouseX, mouseY);
        }
        
        function handleKeyDown(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            switch(e.key) {
                case 'q': case 'Q': setActiveTool('select'); break;
                case 'p': case 'P': setActiveTool('pan'); break;
                case 'n': case 'N': setActiveTool('node'); break;
                case 'x': case 'X': if (!e.ctrlKey) openNodeModal(); break;
                case 'm': case 'M': setActiveTool('member'); break;
                case 's': case 'S': 
                     if (e.ctrlKey) { e.preventDefault(); saveFile(); } 
                     else { setActiveTool('support-pin'); }
                     break;
                case 'r': case 'R': setActiveTool('support-roller'); break;
                case 'l': case 'L': setActiveTool('load'); break;
                case 'v': case 'V': setActiveTool('divide-member'); break;
                case 'Delete': case 'Backspace': 
                    if (activeTool === 'select' && selection) {
                        deleteSelected();
                    } else {
                        setActiveTool('delete'); 
                    }
                    break;
                case 'g': case 'G': 
                    showGrid = !showGrid; 
                    document.getElementById('toggle-grid').classList.toggle('bg-slate-300', showGrid);
                    document.getElementById('toggle-grid').classList.toggle('dark:bg-slate-600', showGrid);
                    draw();
                    break;
                case 'd': case 'D':
                    toggleDeformedView(!isDeformedView);
                    break;
                case 'f': case 'F': zoomToFit(); break;
                case 'Escape': 
                    selectObject(null); 
                    setActiveTool('select'); 
                    memberStartNode = null; 
                    draw();
                    break;
                case '=': case '+': zoom(1.2, canvas.width/2, canvas.height/2); break;
                case '-': case '_': zoom(1/1.2, canvas.width/2, canvas.height/2); break;
            }
        }
        
        // --- LOGIC HELPERS ---
        
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            return {
                x: (mx - transform.x) / transform.k,
                y: (my - transform.y) / transform.k
            };
        }
        
        function snapPoint(pt) {
            if (!enableSnap) return pt;
            const gridInputVal = parseFloat(gridSizeInput.value) || 50;
            const gridSize = toBaseUnit(gridInputVal, 'len');
            
            if (gridSize <= 0) return pt;
            
            return {
                x: Math.round(pt.x / gridSize) * gridSize,
                y: Math.round(pt.y / gridSize) * gridSize
            };
        }
        
        function zoom(factor, centerx, centery) {
            const oldK = transform.k;
            const newK = oldK * factor;
            if (newK < 0.1 || newK > 50) return;
            transform.x = centerx - (centerx - transform.x) * (newK / oldK);
            transform.y = centery - (centery - transform.y) * (newK / oldK);
            transform.k = newK;
            draw();
        }
        
        function zoomToFit() {
            if (nodes.length === 0) {
                transform = { x: 0, y: 0, k: 1 };
                draw();
                return;
            }
            
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            nodes.forEach(n => {
                minX = Math.min(minX, n.x);
                minY = Math.min(minY, n.y);
                maxX = Math.max(maxX, n.x);
                maxY = Math.max(maxY, n.y);
            });
            
            const padding = 50;
            const w = maxX - minX;
            const h = maxY - minY;
            
            if (w === 0 && h === 0) {
                 transform.x = canvas.width/2 - nodes[0].x;
                 transform.y = canvas.height/2 - nodes[0].y;
                 transform.k = 1;
            } else {
                const scaleX = (canvas.width - padding * 2) / w;
                const scaleY = (canvas.height - padding * 2) / h;
                const k = Math.min(scaleX, scaleY, 2); 
                
                transform.k = k;
                transform.x = canvas.width/2 - (minX + w/2) * k;
                transform.y = canvas.height/2 - (minY + h/2) * k;
            }
            draw();
        }
        
        function getClickedNode(pt) {
            const radius = 8 / transform.k; 
            return nodes.find(n => Math.hypot(n.x - pt.x, n.y - pt.y) < radius);
        }
        
        function getClickedMember(pt) {
            const tol = 5 / transform.k;
            return members.find(m => {
                const n1 = nodes.find(n => n.id === m.n1);
                const n2 = nodes.find(n => n.id === m.n2);
                if(!n1 || !n2) return false;
                return pointToLineDistance(pt, n1, n2) < tol;
            });
        }
        
        function getClickedSupport(pt) {
            const radius = 10 / transform.k;
            return supports.find(s => {
                const n = nodes.find(node => node.id === s.nodeId);
                return n && Math.hypot(n.x - pt.x, n.y - pt.y) < radius;
            });
        }
        
        function getClickedLoad(pt) {
            const radius = 15 / transform.k; 
            return loads.find(l => {
                const n = nodes.find(node => node.id === l.nodeId);
                return n && Math.hypot(n.x - pt.x, n.y - pt.y) < radius;
            });
        }
        
        function pointToLineDistance(p, v, w) {
            const l2 = (v.x - w.x)**2 + (v.y - w.y)**2;
            if (l2 === 0) return Math.hypot(p.x - v.x, p.y - v.y);
            let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
            t = Math.max(0, Math.min(1, t));
            return Math.hypot(p.x - (v.x + t * (w.x - v.x)), p.y - (v.y + t * (w.y - v.y)));
        }
        
        function updateHover(pt) {
            const oldHover = hoverItem;
            hoverItem = null;
            
            const n = getClickedNode(pt);
            if (n) { hoverItem = { type: 'node', id: n.id }; }
            else {
                const s = getClickedSupport(pt);
                if (s) { hoverItem = { type: 'support', id: s.id }; }
                else {
                    const l = getClickedLoad(pt);
                    if (l) { hoverItem = { type: 'load', id: l.id }; }
                    else {
                         const m = getClickedMember(pt);
                         if (m) { hoverItem = { type: 'member', id: m.id }; }
                    }
                }
            }
            
            if (oldHover?.id !== hoverItem?.id || oldHover?.type !== hoverItem?.type) {
                draw();
                canvas.style.cursor = hoverItem ? 'pointer' : (activeTool === 'pan' ? 'grab' : 'default');
            }
        }
        
        function updateCoordsDisplay(pt) {
            const display = document.getElementById('coords-display');
            if (!pt) return;
            display.textContent = `X: ${fromBaseUnit(pt.x, 'len').toFixed(1)}, Y: ${fromBaseUnit(-pt.y, 'len').toFixed(1)}`; 
        }

        // --- MODEL MODIFICATION ---
        
        function setActiveTool(tool) {
            activeTool = tool;
            selectObject(null);
            memberStartNode = null;
            draw();
        }
        
        function addNode(x, y) {
            nodes.push({ id: nextNodeId++, x: x, y: y });
            clearAnalysisResults();
            draw();
        }
        
        function addMember(n1Id, n2Id) {
            if (n1Id === n2Id) return;
            if (members.some(m => (m.n1 === n1Id && m.n2 === n2Id) || (m.n1 === n2Id && m.n2 === n1Id))) return;
            
            const defaultE = parseFloat(document.getElementById('default-E').value);
            const defaultA = parseFloat(document.getElementById('default-A').value);
            
            members.push({ 
                id: nextMemberId++, 
                n1: n1Id, 
                n2: n2Id, 
                E: defaultE, 
                A: defaultA 
            });
            clearAnalysisResults();
            draw();
        }
        
        function addSupport(nodeId, type) {
            supports = supports.filter(s => s.nodeId !== nodeId);
            supports.push({ id: nextSupportId++, nodeId: nodeId, type: type });
            clearAnalysisResults();
            draw();
        }
        
        function addLoad(nodeId) {
            loads = loads.filter(l => l.nodeId !== nodeId);
            loads.push({ id: nextLoadId++, nodeId: nodeId, fx: 0, fy: 1000 }); 
            clearAnalysisResults();
            draw();
        }
        
        function deleteNode(id) {
            nodes = nodes.filter(n => n.id !== id);
            members = members.filter(m => m.n1 !== id && m.n2 !== id);
            supports = supports.filter(s => s.nodeId !== id);
            loads = loads.filter(l => l.nodeId !== id);
            clearAnalysisResults();
            selectObject(null);
            draw();
        }
        
        function deleteMember(id) {
            members = members.filter(m => m.id !== id);
            clearAnalysisResults();
            selectObject(null);
            draw();
        }
        
        function deleteSupport(id) {
            supports = supports.filter(s => s.id !== id);
            clearAnalysisResults();
            selectObject(null);
            draw();
        }
        
        function deleteLoad(id) {
            loads = loads.filter(l => l.id !== id);
            clearAnalysisResults();
            selectObject(null);
            draw();
        }
        
        function deleteSelected() {
            if (!selection) return;
            if (selection.type === 'node') deleteNode(selection.id);
            if (selection.type === 'member') deleteMember(selection.id);
            if (selection.type === 'support') deleteSupport(selection.id);
            if (selection.type === 'load') deleteLoad(selection.id);
        }
        
        function openNodeModal() {
            document.getElementById('modal-node-coords').style.display = 'flex';
            document.getElementById('coord-x').value = fromBaseUnit(worldMouse.x, 'len').toFixed(COORD_PRECISION);
            document.getElementById('coord-y').value = fromBaseUnit(worldMouse.y, 'len').toFixed(COORD_PRECISION);
            document.getElementById('coord-x').focus();
        }
        
        function addNodeFromModal() {
            const x = parseFloat(document.getElementById('coord-x').value);
            const y = parseFloat(document.getElementById('coord-y').value);
            
            if (!isNaN(x) && !isNaN(y)) {
                addNode(toBaseUnit(x, 'len'), toBaseUnit(y, 'len'));
                document.getElementById('modal-node-coords').style.display = 'none';
                zoomToFit();
            }
        }
        
        function openDivideModal() {
            document.getElementById('modal-divide-member').style.display = 'flex';
        }
        
        function performDivideMember() {
            if (!selection || selection.type !== 'member') return;
            
            const segs = parseInt(document.getElementById('divide-segments').value);
            if (isNaN(segs) || segs < 2) return;
            
            const member = members.find(m => m.id === selection.id);
            if (!member) return;
            
            const n1 = nodes.find(n => n.id === member.n1);
            const n2 = nodes.find(n => n.id === member.n2);
            
            deleteMember(member.id);
            
            let prevNodeId = n1.id;
            const dx = (n2.x - n1.x) / segs;
            const dy = (n2.y - n1.y) / segs;
            
            for (let i = 1; i < segs; i++) {
                const nx = n1.x + dx * i;
                const ny = n1.y + dy * i;
                const newNodeId = nextNodeId++;
                nodes.push({ id: newNodeId, x: nx, y: ny });
                
                members.push({ 
                    id: nextMemberId++, n1: prevNodeId, n2: newNodeId, 
                    E: member.E, A: member.A 
                });
                prevNodeId = newNodeId;
            }
            members.push({ 
                id: nextMemberId++, n1: prevNodeId, n2: n2.id, 
                E: member.E, A: member.A 
            });
            
            document.getElementById('modal-divide-member').style.display = 'none';
            clearAnalysisResults();
            selectObject(null);
            draw();
        }

        function selectObject(item) {
            selection = item;
            propNone.classList.add('hidden');
            propNode.classList.add('hidden');
            propMember.classList.add('hidden');
            propSupport.classList.add('hidden');
            propLoad.classList.add('hidden');
            
            if (!item) {
                propTitle.textContent = "Properties";
                propNone.classList.remove('hidden');
                draw();
                return;
            }
            
            propertiesPanel.classList.remove('hidden');
            
            switch (item.type) {
                case 'node':
                    const node = nodes.find(n => n.id === item.id);
                    if (!node) return;
                    propTitle.textContent = "Node Properties";
                    document.getElementById('prop-node-id').textContent = node.id;
                    document.getElementById('prop-node-x').value = fromBaseUnit(node.x, 'len').toFixed(COORD_PRECISION);
                    document.getElementById('prop-node-y').value = fromBaseUnit(node.y, 'len').toFixed(COORD_PRECISION);
                    propNode.classList.remove('hidden');
                    break;
                case 'member':
                    const member = members.find(m => m.id === item.id);
                    if (!member) return;
                    propTitle.textContent = "Member Properties";
                    document.getElementById('prop-member-id').textContent = member.id;
                    document.getElementById('prop-member-e').value = member.E;
                    document.getElementById('prop-member-a').value = member.A;
                    propMember.classList.remove('hidden');
                    break;
                case 'support':
                    const support = supports.find(s => s.id === item.id);
                    if (!support) return;
                    propTitle.textContent = "Support Properties";
                    document.getElementById('prop-support-node').textContent = support.nodeId;
                    document.getElementById('prop-support-type').value = support.type;
                    propSupport.classList.remove('hidden');
                    break;
                case 'load':
                    const load = loads.find(l => l.id === item.id);
                    if (!load) return;
                    propTitle.textContent = "Load Properties";
                    document.getElementById('prop-load-node').textContent = load.nodeId;
                    document.getElementById('prop-load-fx').value = fromBaseUnit(load.fx, 'force').toFixed(2);
                    document.getElementById('prop-load-fy').value = fromBaseUnit(load.fy, 'force').toFixed(2);
                    propLoad.classList.remove('hidden');
                    break;
            }
            draw();
        }
        
        function updateNodeProp(coord, value) {
            if (!selection || selection.type !== 'node') return;
            const node = nodes.find(n => n.id === selection.id);
            if (node) {
                node[coord] = toBaseUnit(parseFloat(value), 'len');
                if (analysisRun) clearAnalysisResults();
                draw();
            }
        }
        
        function updateMemberProp(prop, value) {
            if (!selection || selection.type !== 'member') return;
            const member = members.find(m => m.id === selection.id);
            if (member) {
                member[prop] = parseFloat(value);
                if (analysisRun) clearAnalysisResults();
            }
        }
        
        function updateSupportProp(value) {
             if (!selection || selection.type !== 'support') return;
             const support = supports.find(s => s.id === selection.id);
             if (support) {
                 support.type = value;
                 if (analysisRun) clearAnalysisResults();
                 draw();
             }
        }
        
        function updateLoadProp(comp, value) {
             if (!selection || selection.type !== 'load') return;
             const load = loads.find(l => l.id === selection.id);
             if (load) {
                 load[comp] = toBaseUnit(parseFloat(value), 'force');
                 if (analysisRun) clearAnalysisResults();
                 draw();
             }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        function handleAnalyze() {
            try {
                analysisStatus.textContent = "Analyzing...";
                analysisStatus.className = "p-2 rounded-md mb-3 text-sm bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";
                resultsContainer.classList.remove('hidden');
                
                if (nodes.length < 2) throw new Error("Not enough nodes.");
                if (members.length < 1) throw new Error("Not enough members.");
                if (supports.length < 1) throw new Error("Not enough supports. Structure is unstable.");
                
                const nodeMap = new Map(); 
                nodes.forEach((n, i) => nodeMap.set(n.id, i));
                
                const numNodes = nodes.length;
                const numDOF = numNodes * 2;
                
                let K = math.zeros(numDOF, numDOF);
                
                // --- BEGIN CALC LOG ---
                let log = "--- 2D TRUSS ANALYSIS CALCULATION REPORT ---\n";
                log += `Date: ${new Date().toLocaleString()}\n`;
                log += `Units: ${currentUnitSystem.toUpperCase()}\n\n`;
                
                log += "1. MODEL DATA (Internal Base Units: mm, N, MPa)\n";
                log += `Nodes: ${nodes.length}, Members: ${members.length}\n`;
                log += "Nodes:\n" + nodes.map(n => `  ID: ${n.id}, X: ${n.x.toFixed(2)}, Y: ${n.y.toFixed(2)}`).join('\n') + "\n\n";
                
                log += "2. ELEMENT STIFFNESS MATRICES (Local k)\n";
                
                members.forEach(member => {
                    const i = nodeMap.get(member.n1); 
                    const j = nodeMap.get(member.n2); 
                    const n1 = nodes[i];
                    const n2 = nodes[j];
                    const dx = n2.x - n1.x;
                    const dy = n2.y - n1.y;
                    const L = Math.hypot(dx, dy);
                    if (L === 0) throw new Error(`Member M${member.id} has zero length.`);
                    const c = dx / L; 
                    const s = dy / L; 
                    
                    const k_const = (member.E * member.A) / L;
                    
                    log += `Member M${member.id} (Node ${member.n1} -> ${member.n2}):\n`;
                    log += `  L=${L.toFixed(2)}, E=${member.E}, A=${member.A}\n`;
                    log += `  cos=${c.toFixed(4)}, sin=${s.toFixed(4)}, k'=EA/L=${k_const.toFixed(2)}\n`;
                    
                    const k_local = math.matrix([
                        [ c*c,  c*s, -c*c, -c*s],
                        [ c*s,  s*s, -c*s, -s*s],
                        [-c*c, -c*s,  c*c,  c*s],
                        [-c*s, -s*s,  c*s,  s*s]
                    ]).map(val => val * k_const);
                    
                    // Pretty print matrix
                    log += `  k matrix:\n`;
                    k_local.forEach((val, idx) => {
                        const r = idx[0];
                        const c = idx[1];
                        if(c===0) log += "  [ ";
                        log += val.toFixed(1).padStart(10, " ") + " ";
                        if(c===3) log += "]\n";
                    });
                    log += "\n";
                    
                    const dofs = [2*i, 2*i+1, 2*j, 2*j+1];
                    for (let r = 0; r < 4; r++) {
                        for (let col = 0; col < 4; col++) {
                            const globalR = dofs[r];
                            const globalC = dofs[col];
                            const current = K.get([globalR, globalC]);
                            K.set([globalR, globalC], current + k_local.get([r, col]));
                        }
                    }
                });
                
                log += "3. GLOBAL STIFFNESS MATRIX (K)\n";
                K.forEach((val, index) => {
                    const r = index[0];
                    const c = index[1];
                    if (c === 0) log += "[ ";
                    log += val.toFixed(1).padStart(10, " ") + " ";
                    if (c === numDOF - 1) log += "]\n";
                });
                log += "\n";
                
                let F = math.zeros(numDOF);
                loads.forEach(load => {
                    const i = nodeMap.get(load.nodeId);
                    if (i !== undefined) {
                        F.set([2*i], F.get([2*i]) + load.fx);
                        F.set([2*i+1], F.get([2*i+1]) + load.fy);
                    }
                });
                
                log += "4. LOAD VECTOR (F)\n";
                F.forEach((val, index) => {
                    log += `[ ${val.toFixed(2)} ]\n`;
                });
                log += "\n";
                
                let freeDOFs = [];
                let restrainedDOFs = new Set();
                
                supports.forEach(supp => {
                    const i = nodeMap.get(supp.nodeId);
                    if (supp.type === 'pinned') {
                        restrainedDOFs.add(2*i);     
                        restrainedDOFs.add(2*i + 1); 
                    } else if (supp.type === 'roller-y') {
                        restrainedDOFs.add(2*i + 1); 
                    } else if (supp.type === 'roller-x') {
                        restrainedDOFs.add(2*i);     
                    }
                });
                
                for (let i = 0; i < numDOF; i++) {
                    if (!restrainedDOFs.has(i)) {
                        freeDOFs.push(i);
                    }
                }
                
                if (freeDOFs.length === 0) throw new Error("Structure is fully constrained (no degrees of freedom).");

                let K_ff = math.subset(K, math.index(freeDOFs, freeDOFs));
                let F_f = math.subset(F, math.index(freeDOFs));
                
                let D_f;
                try {
                     const det = math.det(K_ff);
                     if (Math.abs(det) < 1e-10) throw new Error("Structure is unstable (Singular stiffness matrix).");
                     const K_inv = math.inv(K_ff);
                     D_f = math.multiply(K_inv, F_f);
                } catch (e) {
                    throw new Error("Matrix solution failed. Structure likely unstable.");
                }
                
                let D = math.zeros(numDOF);
                freeDOFs.forEach((dofIndex, k) => {
                    D.set([dofIndex], D_f.get([k]));
                });
                
                log += "5. NODAL DISPLACEMENTS (D)\n";
                D.forEach((val, index) => {
                    log += `[ ${val.toExponential(4)} ]\n`;
                });
                log += "\n";
                
                let R = math.subtract(math.multiply(K, D), F);
                
                displacements = [];
                nodes.forEach((n, i) => {
                    displacements.push({
                        nodeId: n.id,
                        dx: D.get([2*i]),
                        dy: D.get([2*i+1])
                    });
                });
                
                reactions = [];
                supports.forEach(supp => {
                    const i = nodeMap.get(supp.nodeId);
                    let rx = 0, ry = 0;
                    if (supp.type === 'pinned') {
                        rx = R.get([2*i]);
                        ry = R.get([2*i+1]);
                    } else if (supp.type === 'roller-y') {
                        ry = R.get([2*i+1]);
                    } else if (supp.type === 'roller-x') {
                        rx = R.get([2*i]);
                    }
                    reactions.push({ nodeId: supp.nodeId, rx: rx, ry: ry });
                });
                
                log += "6. MEMBER FORCES & STRESSES\n";
                for (const member of members) {
                    const i = nodeMap.get(member.n1);
                    const j = nodeMap.get(member.n2);
                    const n1 = nodes[i];
                    const n2 = nodes[j];
                    
                    const d1x = D.get([i*2]);
                    const d1y = D.get([i*2+1]);
                    const d2x = D.get([j*2]);
                    const d2y = D.get([j*2+1]);
                    
                    const dx = n2.x - n1.x;
                    const dy = n2.y - n1.y;
                    const L = Math.hypot(dx, dy);
                    const c = dx/L;
                    const s = dy/L;
                    
                    const elongation = (d2x - d1x)*c + (d2y - d1y)*s;
                    const strain = elongation / L;
                    const stress = member.E * strain;
                    const force = stress * member.A;
                    
                    member.force = force;
                    member.stress = stress;
                    
                    log += `M${member.id}: Force = ${force.toFixed(2)} N, Stress = ${stress.toFixed(2)} MPa\n`;
                }
                
                log += "\n7. REACTIONS\n";
                reactions.forEach(r => {
                    log += `Node ${r.nodeId}: Rx=${r.rx.toFixed(2)}, Ry=${r.ry.toFixed(2)}\n`;
                });
                
                analysisRun = true;
                document.getElementById('save-calc-report').dataset.log = log;
                displayResults();
                analysisStatus.textContent = "Analysis Complete.";
                analysisStatus.className = "p-2 rounded-md mb-3 text-sm bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";
                
            } catch (error) {
                if (error.message.includes("Not enough") || error.message.includes("unstable")) {
                } else {
                    console.error("Analysis failed:", error);
                }
                analysisStatus.textContent = "Error: " + error.message;
                analysisStatus.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                resultsContainer.classList.remove('hidden');
                document.getElementById('results-tables').classList.add('hidden'); 
            }
        }
        
        function displayResults() {
            if (!analysisRun) return;
            document.getElementById('results-tables').classList.remove('hidden');
            
            memberForcesTbody.innerHTML = "";
            members.forEach(m => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700";
                let colorClass = "";
                if (m.force > 0.1) colorClass = "text-blue-600 dark:text-blue-400"; 
                else if (m.force < -0.1) colorClass = "text-red-600 dark:text-red-400"; 
                
                const f_disp = fromBaseUnit(m.force, 'force');
                const s_disp = fromBaseUnit(m.stress, 'pressure');

                tr.innerHTML = `
                    <td class="px-3 py-1.5 font-medium">M${m.id} <span class="text-xs text-slate-400">(${m.n1}-${m.n2})</span></td>
                    <td class="px-3 py-1.5 text-right ${colorClass}">${f_disp.toFixed(2)}</td>
                    <td class="px-3 py-1.5 text-right ${colorClass}">${s_disp.toFixed(2)}</td>
                `;
                memberForcesTbody.appendChild(tr);
            });
            
            reactionsTbody.innerHTML = "";
            reactions.forEach(r => {
                if (Math.abs(r.rx) < 0.1 && Math.abs(r.ry) < 0.1) return;
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700";
                tr.innerHTML = `
                    <td class="px-3 py-1.5">${r.nodeId}</td>
                    <td class="px-3 py-1.5 text-right">${fromBaseUnit(r.rx, 'force').toFixed(2)}</td>
                    <td class="px-3 py-1.5 text-right">${fromBaseUnit(r.ry, 'force').toFixed(2)}</td>
                `;
                reactionsTbody.appendChild(tr);
            });
            
            displacementsTbody.innerHTML = "";
            displacements.forEach(d => {
                 const tr = document.createElement('tr');
                tr.className = "border-b border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700";
                tr.innerHTML = `
                    <td class="px-3 py-1.5">${d.nodeId}</td>
                    <td class="px-3 py-1.5 text-right">${fromBaseUnit(d.dx, 'len').toFixed(4)}</td>
                    <td class="px-3 py-1.5 text-right">${fromBaseUnit(d.dy, 'len').toFixed(4)}</td>
                `;
                displacementsTbody.appendChild(tr);
            });
            
            if (isDeformedView) draw();
        }
        
        function getDeformedNodes() {
            const scale = parseFloat(dispScaleInput.value) || 100;
            return nodes.map(n => {
                const disp = displacements.find(d => d.nodeId === n.id);
                if (!disp) return { ...n };
                return {
                    id: n.id,
                    x: n.x + disp.dx * scale,
                    y: n.y + disp.dy * scale 
                };
            });
        }

        function handleDispScaleChange(e) {
            if (isDeformedView) draw();
        }

        function toggleDeformedView(show) {
            isDeformedView = show;
            deformedToggleBtn.classList.toggle('bg-slate-300', show);
            deformedToggleBtn.classList.toggle('dark:bg-slate-600', show);
            
            if (show) {
                if (!analysisRun) handleAnalyze();
                dispScaleContainer.classList.remove('hidden');
                dispScaleContainer.classList.add('flex');
                selectObject(null);
                propertiesPanel.classList.add('hidden');
            } else {
                dispScaleContainer.classList.add('hidden');
                dispScaleContainer.classList.remove('flex');
                propertiesPanel.classList.remove('hidden');
            }
            draw();
        }
        
        function clearAnalysisResults() {
            analysisRun = false;
            displacements = [];
            reactions = [];
            members.forEach(m => { m.force = 0; m.stress = 0; });
            resultsContainer.classList.add('hidden');
            analysisStatus.textContent = "";
            analysisStatus.className = "p-2 rounded-md mb-3 text-sm";
            
            if (isDeformedView) {
                isDeformedView = false;
                toggleDeformedView(false);
            }
            draw();
        }
        
        function saveFile() {
            const data = {
                nodes, members, supports, loads,
                nextNodeId, nextMemberId, nextSupportId, nextLoadId,
                defaults: {
                    E: document.getElementById('default-E').value,
                    A: document.getElementById('default-A').value
                },
                view: {
                     propScale, showNodeLabels, showMemberLabels, showLoadValues
                },
                currentUnitSystem
            };
            const a = document.createElement('a');
            const file = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            a.href = URL.createObjectURL(file);
            a.download = 'truss_model.truss';
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        function handleFileOpen(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    nodes = data.nodes || [];
                    members = data.members || [];
                    supports = data.supports || [];
                    loads = data.loads || [];
                    nextNodeId = data.nextNodeId || 1;
                    nextMemberId = data.nextMemberId || 1;
                    nextSupportId = data.nextSupportId || 1;
                    nextLoadId = data.nextLoadId || 1;
                    
                    if(data.defaults) {
                         document.getElementById('default-E').value = data.defaults.E;
                         document.getElementById('default-A').value = data.defaults.A;
                    }
                    if (data.view) {
                        propScale = data.view.propScale || 1.0;
                        document.getElementById('prop-scale').value = propScale;
                        document.getElementById('prop-scale-value').textContent = propScale;
                        showNodeLabels = !!data.view.showNodeLabels;
                        document.getElementById('toggle-node-labels').checked = showNodeLabels;
                        showMemberLabels = !!data.view.showMemberLabels;
                         document.getElementById('toggle-member-labels').checked = showMemberLabels;
                        showLoadValues = data.view.showLoadValues !== undefined ? !!data.view.showLoadValues : true;
                        document.getElementById('toggle-load-values').checked = showLoadValues;
                    }
                    
                    currentUnitSystem = data.currentUnitSystem || 'metric';
                    unitSystemSelect.value = currentUnitSystem;
                    updateUnitSystemUI();

                    clearAnalysisResults();
                    zoomToFit();
                    
                } catch(err) {
                    alert("Error loading file: " + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        }
        
        function saveImage(format) {
            const rect = canvas.getBoundingClientRect();
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = rect.width;
            tempCanvas.height = rect.height;
            const tempCtx = tempCanvas.getContext('2d');
            const originalCtx = ctx;
            const a = document.createElement('a');
            a.href = canvas.toDataURL("image/png");
            a.download = "truss_diagram.png";
            a.click();
        }

        function handleSaveReport() {
            if (!analysisRun) {
                alert("Please run an analysis first.");
                return;
            }
            document.getElementById('modal-progress').style.display = 'flex';
            setTimeout(() => {
                try {
                    generatePDF();
                } catch(e) {
                    console.error(e);
                    alert("Error generating PDF: " + e.message);
                } finally {
                    document.getElementById('modal-progress').style.display = 'none';
                }
            }, 100);
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            if (typeof doc.autoTable !== 'function') {
                alert("Error: jsPDF-AutoTable plugin not loaded.");
                return;
            }
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 15;
            
            doc.setFontSize(18);
            doc.text("Truss Analysis Report", margin, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.text(`Date: ${new Date().toLocaleString()}`, margin, y);
            y += 15;
            
            let maxTension = 0, maxComp = 0, maxDisp = 0;
            members.forEach(m => {
                if (m.force > 0) maxTension = Math.max(maxTension, m.force);
                else maxComp = Math.min(maxComp, m.force);
            });
            displacements.forEach(d => {
                const dist = Math.sqrt(d.dx**2 + d.dy**2);
                maxDisp = Math.max(maxDisp, dist);
            });
            
            const u = unitSystems[currentUnitSystem];
            
            const stats = [
                ["Nodes", nodes.length.toString()],
                ["Members", members.length.toString()],
                ["Max Tension", `${fromBaseUnit(maxTension, 'force').toFixed(2)} ${u.force}`],
                ["Max Compression", `${fromBaseUnit(Math.abs(maxComp), 'force').toFixed(2)} ${u.force}`],
                ["Max Displacement", `${fromBaseUnit(maxDisp, 'len').toFixed(4)} ${u.len}`]
            ];
            
            doc.autoTable({
                startY: y,
                head: [['Statistic', 'Value']],
                body: stats,
                theme: 'striped',
                headStyles: { fillColor: [37, 99, 235] }, 
                margin: { left: margin, right: margin }
            });
            
            y = doc.lastAutoTable.finalY + 15;
            
            doc.setFontSize(12);
            doc.text("Member Forces", margin, y);
            y += 5;
            
            const memberRows = members.map(m => [
                `M${m.id}`,
                `${m.n1} - ${m.n2}`,
                fromBaseUnit(m.force, 'force').toFixed(2),
                (m.force > 0 ? "Tens." : (m.force < 0 ? "Comp." : "Zero")),
                fromBaseUnit(m.stress, 'pressure').toFixed(2)
            ]);
            
            doc.autoTable({
                startY: y,
                head: [['ID', 'Nodes', `Force (${u.force})`, 'State', `Stress (${u.pressure})`]],
                body: memberRows,
                theme: 'striped',
                headStyles: { fillColor: [75, 85, 99] }, 
                margin: { left: margin, right: margin }
            });
             
            y = doc.lastAutoTable.finalY + 15;
            
            doc.setFontSize(12);
            doc.text("Reactions", margin, y);
            y += 5;
            
            const reacRows = reactions.map(r => [
                r.nodeId,
                fromBaseUnit(r.rx, 'force').toFixed(2),
                fromBaseUnit(r.ry, 'force').toFixed(2)
            ]);
            
             doc.autoTable({
                startY: y,
                head: [['Node', `Rx (${u.force})`, `Ry (${u.force})`]],
                body: reacRows,
                theme: 'striped',
                headStyles: { fillColor: [75, 85, 99] },
                margin: { left: margin, right: margin }
            });
            
            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = pageWidth - 2 * margin;
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            if (doc.lastAutoTable.finalY + pdfHeight + 20 > doc.internal.pageSize.getHeight()) {
                doc.addPage();
                y = 20;
            } else {
                y = doc.lastAutoTable.finalY + 20;
            }
            
            doc.addImage(imgData, 'PNG', margin, y, pdfWidth, pdfHeight);
            
            doc.save("Truss_Report.pdf");
        }

    </script>
</body>
</html>